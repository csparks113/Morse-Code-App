# Outputs Alignment Notes (2025-10-10)

The console/receive/send flows now consume the Nitro monotonic timeline end-to-end. Symbol timestamps, latency logging, and torch scheduling all run against `monotonicTimestampMs` + `timelineOffsetMs`, so JS latency sampling matches the native schedule.

## Current Snapshot
- Dots/dashes in Play Pattern runs show `outputs.flashPulse.commit` and `touchToTorch` latencies tracking Nitro offsets within roughly 5-15 ms (see `docs/logs/console-replay-20251010-aligned.md`).
- Torch enable/disable traces (`keyer.torch.start/stop`) fire immediately after presses and emit offsets/metadata for diagnostics.
- `playMorse.nativeOffset.spike` traces trigger when native offsets exceed about 80 ms, letting us inspect Nitro sequence jumps without digging through raw payloads.
- Live keyer telemetry now threads `monotonicTimestampMs`, keeping live sweeps aligned with replay traces and the analyzer output.
- Analyzer now prints a >=80 ms native-offset table on every run and can export comparison CSVs (see `docs/logs/spike-summary-play-pattern-20251011.csv` for the 13:37/14:14/14:41/14:46/14:59/15:02 Play Pattern runs).
- Developer-console flash pulses now dispatch with an 8 ms timeline lead so JS can fire slightly ahead of the audio channel; watch the next sweeps to confirm the mean audio->flash delta tightens.
- `outputs.flashPulse.commit` now logs `scheduleSkewMs` (plus `audioStartHeadroomMs`, `audioStartGuard`, and `audioStartCompensationMs`)  to track how accurately the JS timer hits the target start.
- Flash traces also emit `preScheduleLeadMs` and the new `audioStartLeadMs`: the JS dispatcher smooths recent `scheduleSkewMs`, preps `requestAnimationFrame` up to ~190 ms early, applies a capped (<=96 ms) audio-start lead with a small guard margin, and now seeds scheduling from `nativeExpectedTimestampMs`; if headroom drops under ~6 ms we clear compensation and fall back to a 12 ms timeline offset (with 8 ms lead) so flashes do not ride zero headroom. Timeline fallbacks now execute via `scheduleMonotonic`, eliminating RAF/setTimeout drift.
- Flash scheduling now prefers `audioStartMs` when we have >=12 ms of headroom, sane native skew, and fresh timestamps; otherwise we fall back to the timeline offset and tag traces with `schedulingMode` so we can see when the guard trips.
- 2025-10-12 18:16 Play Pattern replay (`docs/logs/console-replay-20251012-181629-play-pattern.txt`) shows the guard clears `audioStartCompensationMs`, yet every commit stayed in timeline mode with `audioStartGuard=headroom`, headroom averaging -48 ms (p95 -17 ms), and `scheduleSkewMs` sitting at 79 ms mean / 129 ms p95 (max 524 ms); 40 ms symbols continue to supply nearly half of the >=150 ms spikes—see `docs/logs/play-pattern-20251012-181629-timeline.csv`.
- 2025-10-12 18:33 Play Pattern replay (`docs/logs/console-replay-20251012-183307-play-pattern.txt`) keeps the compensation reset but still forces timeline-only commits; `scheduleSkewMs` climbs to 106 ms mean / 325 ms p95 (max 617 ms) with headroom averaging -46 ms (min -496 ms) and the >=150 ms skew tail led by 30 ms and 90 ms pulses—see `docs/logs/play-pattern-20251012-183307-timeline.csv`.
- 2025-10-12 18:46 Play Pattern replay (`docs/logs/console-replay-20251012-184610-play-pattern.txt`) shows the guard still glued to `audioStartGuard=headroom`; `scheduleSkewMs` widens to 119 ms mean / 331 ms p95 (max 617 ms) while headroom only recovers to -35 ms mean (p95 ~12 ms). 40 ms pulses now edge out 30 ms in the >=150 ms skew bucket; see `docs/logs/play-pattern-20251012-184610-timeline.csv`.
- 2025-10-12 18:52 Play Pattern replay (`docs/logs/console-replay-20251012-185225-play-pattern.txt`) keeps the guard latched; headroom creeps up to -27 ms mean yet every commit stays timeline. `scheduleSkewMs` holds at 121 ms mean / 303 ms p95 (max 617 ms) with the >=150 ms tail shifting toward 40 ms (28%) and 120 ms (18%) pulses—see `docs/logs/play-pattern-20251012-185225-timeline.csv`.
- 2025-10-12 19:01 Play Pattern replay (`docs/logs/console-replay-20251012-190102-play-pattern.txt`) appends 65 `session.receive.replay` pulses after the Play Pattern run; the Play Pattern commits still log `audioStartGuard=headroom` (headroom mean -17 ms, p95 ~12 ms) with `scheduleSkewMs` at 120 ms mean / 271 ms p95 (max 617 ms). 40 ms symbols now make up ~33% of the >=150 ms skew tail, while the receive pulses show blank guard/headroom and ~68 ms skew—see `docs/logs/play-pattern-20251012-190102-timeline.csv`.
- 2025-10-12 19:17 Play Pattern replay (`docs/logs/console-replay-20251012-191728-play-pattern.txt`) again includes the trailing receive replay; Play Pattern commits remain timeline-only with headroom pinned at 12 ms and skew averaging 123 ms (p95 197 ms, max 396 ms), while the appended receive pulses (147 blank-guard rows + 199 headroom rows) average ~65 ms skew. Analyzer means explode (>6 min) simply because we left receive replay running until stop—see `docs/logs/play-pattern-20251012-191728-timeline.csv`.
- 2025-10-12 19:29 Play Pattern replay (`docs/logs/console-replay-20251012-192955-play-pattern.txt`) ran from a cleared logcat; the sweep itself sits at 33.5 ms audio->flash mean / 86.98 ms p95 with all 160 commits still timeline-only and headroom fixed at 12 ms. Skew averages 122 ms (p95 186 ms, max 311 ms) with 40 ms and 120 ms symbols driving most >=150 ms spikes—see `docs/logs/play-pattern-20251012-192955-timeline.csv`.
- 2025-10-12 19:40 Play Pattern replay (`docs/logs/console-replay-20251012-194045-play-pattern.txt`) shows only 39 of 160 commits falling back, but they do so under `audioStartGuard=age` with headroom around -87 ms (min -175 ms) and skew near 84 ms mean / 161 ms max; the rest stay in audio-start mode yet the guard still flips on short 40 ms symbols. Timeline fallbacks listed in `docs/logs/play-pattern-20251012-194045-timeline.csv`.
- 2025-10-12 19:51 Play Pattern replay (`docs/logs/console-replay-20251012-195117-play-pattern.txt`) trimmed the fallback count further (15 of 162 commits) but every fallback still logs `audioStartGuard=age` with headroom around -123 ms (min -163 ms) and skew climbing to 199 ms on 40 ms symbols—see `docs/logs/play-pattern-20251012-195117-timeline.csv`.
- 2025-10-12 20:00 Play Pattern replay (`docs/logs/console-replay-20251012-200042-play-pattern.txt`) only dropped 8 commits, yet each fallback still hits `audioStartGuard=age` with headroom around -123 ms (min -143 ms) and skew up to 185 ms; adjust the guard before the next sweep—see `docs/logs/play-pattern-20251012-200042-timeline.csv`.
- 2025-10-12 20:15 Play Pattern replay - 2025-10-12 20:42 Play Pattern replay (`docs/logs/console-replay-20251012-204202-play-pattern.txt`) finally stayed in audio-start for every commit; no timeline fallbacks were recorded, so the guard held with positive headroom throughout.
- 2025-10-12 21:16 Play Pattern replay (`docs/logs/console-replay-20251012-211640-play-pattern.txt`) repeats the clean sweep: audio-start remained active, timeline never triggered, and we did not produce a fallback CSV.
(`docs/logs/console-replay-20251012-201554-play-pattern.txt`) cut the timeline fallbacks to six, but the guard still flips to `age` with headroom about -120 ms; skew tops out near 111 ms—see `docs/logs/play-pattern-20251012-201554-timeline.csv`.
- 2025-10-12 20:42 Play Pattern replay (`docs/logs/console-replay-20251012-204202-play-pattern.txt`) finally stayed in audio-start for every commit; no timeline fallbacks were recorded, so the guard held with positive headroom throughout.
- 2025-10-11 Play Pattern captures:
  - `docs/logs/console-replay-20251011-120130-play-pattern.txt` lacked native offsets and showed large audio->flash/haptic drift (~312 ms mean).
  - `docs/logs/console-replay-20251011-122422-play-pattern.txt` rerun through the JSON-aware analyzer now lands at audio->flash mean 17.1 ms (p95 69.3 ms), audio->haptic mean 17.0 ms (p95 68.7 ms), and native alignment mean 29.4 ms (p95 86.0 ms) with no spike traces.
  - `docs/logs/console-replay-20251011-133707-play-pattern.txt` captures the aligned baseline (audio->flash mean 20.8 ms, audio->haptic mean 20.3 ms, native delay mean 32.2 ms, p95 90.6 ms) and includes four `playMorse.nativeOffset.spike` events between 80-100 ms on unit lengths 30/34/48.
  - `docs/logs/console-replay-20251011-141417-play-pattern.txt` shows the drift (audio->flash mean 39.5 ms, audio->haptic mean 45.8 ms, flash commit mean 223.6 ms, native alignment mean 42.1 ms, p95 122.1 ms) and expands the spike cluster to 20 traces >= 80 ms across unitMs 60/48/40/34/30 (details in `docs/logs/spike-summary-play-pattern-20251011.csv`).
  - `docs/logs/console-replay-20251011-144151-play-pattern.txt` followed immediately after the drift run and landed at audio->flash mean 24.8 ms (p95 63.7 ms), audio->haptic mean 23.4 ms (p95 63.0 ms), flash commit mean 95.3 ms (p95 135 ms), and native alignment mean 22.9 ms (p95 62.5 ms). Eight offsets >= 80 ms remained (unitMs 30/34/40, max 121.8 ms), pointing to a transient cluster.
  - `docs/logs/console-replay-20251011-144639-play-pattern.txt` stayed on target (audio->flash mean 24.3 ms, p95 58.0 ms; audio->haptic mean 22.6 ms, p95 57.3 ms; flash commit mean 77.5 ms, p95 108 ms; native alignment mean 21.8 ms, p95 57.0 ms) with no offsets >= 80 ms.
  - `docs/logs/console-replay-20251011-145909-play-pattern.txt` continued to hold form (audio->flash mean 24.6 ms, p95 60.4 ms; native alignment mean 22.4 ms, p95 59.2 ms) with four offsets >= 80 ms (unitMs 40, max 94.8 ms).
  - `docs/logs/console-replay-20251011-150200-play-pattern.txt` stayed in band (audio->flash mean 25.7 ms, p95 66.1 ms; audio->haptic mean 24.0 ms, p95 65.4 ms; flash commit mean 76.5 ms, p95 104 ms; native alignment mean 22.7 ms, p95 64.9 ms) with four offsets >= 80 ms (unitMs 40, max 85.2 ms).
  - `docs/logs/console-replay-20251011-152657-play-pattern.txt` captured the post-lead check (audio->flash mean 25.7 ms, p95 75.8 ms; audio->haptic mean 24.5 ms, p95 75.2 ms; flash commit mean 91.3 ms, p95 154 ms; native alignment mean 23.9 ms, p95 74.6 ms) with seven offsets >= 80 ms (unitMs 34/40/48, max 109.8 ms); correlation IDs are listed in the spike summary for deeper inspection.
  - `docs/logs/console-replay-20251011-154840-play-pattern.txt` shows the 8 ms lead plus `audioStartMs` alignment holding mid-20 ms means (audio->flash 24.5 ms mean / 58.1 ms p95; audio->haptic 23.0 ms mean / 57.3 ms p95; flash commit 78.3 ms mean / 123.0 ms p95) while three unitMs 40 symbols still hit >= 80 ms (max 90.6 ms) and one payload omitted `nativeTimestampMs`; `scheduleSkewMs` points to ~62-70 ms of JS timer lag on those spikes.
  - `docs/logs/console-replay-20251011-161229-play-pattern.txt` regressed immediately after the audio clock wiring: audio->flash mean 40.3 ms (p95 119.4 ms), audio->haptic 39.2 ms (p95 118.6 ms), flash commit 140.7 ms (p95 207.0 ms), native alignment mean 40.2 ms (p95 125.0 ms), 18 offsets >= 80 ms (unitMs 34/40/48/60, peak 198.7 ms), and seven payloads lacked `nativeTimestampMs`; the new flash scheduling path likely needs guardrails.
  - `docs/logs/console-replay-20251011-162210-play-pattern.txt` captured only the first 10 symbols (app restart mid-sweep) but shows the baseline returning: audio->flash mean 18.1 ms (p95 33.0 ms), audio->haptic mean 16.1 ms (p95 30.5 ms), flash commit mean 84.4 ms (p95 107.0 ms), native alignment mean 14.4 ms (p95 26.0 ms), zero >=80 ms spikes, and all payloads include `nativeTimestampMs`; rerun with full coverage once the audioStart fix lands.
  - `docs/logs/console-replay-20251011-163246-play-pattern.txt` reflects the post-restart sweep: audio->flash mean 27.1 ms (p95 58.5 ms), audio->haptic mean 25.4 ms (p95 57.7 ms), flash commit mean 78.4 ms (p95 117.0 ms); native alignment mean 24.4 ms (p95 57.3 ms) with four spikes >= 80 ms (unitMs 40 at 114.5/88.8/81.3 ms, unitMs 48 at 121.1 ms) and complete `nativeTimestampMs` coverage--baseline restored but unitMs 40/48 still flirt with the spike threshold.
  - `docs/logs/console-replay-20251011-165958-play-pattern.txt` continues the audioStart pass with a tighter mean: audio->flash 24.9 ms (p95 62.3 ms), audio->haptic 22.9 ms (p95 61.2 ms), flash commit 79.6 ms (p95 113.0 ms); native alignment mean 21.7 ms (p95 60.7 ms) and only two spikes >= 80 ms (unitMs 40 at 83.0 / 81.3 ms) though one payload dropped `nativeTimestampMs`; `scheduleSkewMs` stayed ~60 ms on those spikes.
  - `docs/logs/console-replay-20251011-171837-play-pattern.txt` shows the latest sweep: audio->flash mean 28.0 ms (p95 73.2 ms), audio->haptic mean 26.7 ms (p95 72.5 ms), flash commit mean 83.0 ms (p95 131.0 ms); native alignment mean 26.1 ms (p95 72.0 ms) with six spikes >= 80 ms (unitMs 30 peaking at 120.2 ms, unitMs 34 at 108.9/98.8 ms, unitMs 40 at 83.9 ms) and three missing `nativeTimestampMs`; `scheduleSkewMs` for the spikes ranges 62-142 ms, pointing back to replay batching.
  - `docs/logs/console-replay-20251011-173500-play-pattern.txt` keeps the audioStart wiring active: audio->flash mean 24.6 ms (p95 61.5 ms), audio->haptic mean 23.3 ms (p95 60.8 ms), flash commit mean 94.3 ms (p95 118.0 ms); native alignment mean 22.8 ms (p95 60.3 ms) with four spikes >= 80 ms (unitMs 30 at 86.4 ms, unitMs 40 at 116.0/82.7/80.3 ms) and four missing `nativeTimestampMs`. `audioStartGuard=headroom` triggered with negative headroom and `scheduleSkewMs` ~35-88 ms on those spikes, underscoring the need for tighter scheduling guardrails.
  - `docs/logs/console-replay-20251011-175743-play-pattern.txt` adds another pass: audio->flash mean 26.5 ms (p95 69.0 ms), audio->haptic mean 25.2 ms (p95 68.3 ms), flash commit mean 91.9 ms (p95 127.0 ms); native alignment mean 24.7 ms (p95 72.7 ms) with six spikes >= 80 ms (unitMs 34 at 108.0/96.7/95.8 ms, unitMs 40 at 109.2/92.7/82.1 ms) and four missing `nativeTimestampMs`; `audioStartGuard=headroom` remained in play with `scheduleSkewMs` roughly 58-100 ms, pointing to persistent replay batching skew.
  - `docs/logs/console-replay-20251011-180457-play-pattern.txt` keeps the trend: audio->flash mean 23.8 ms (p95 63.5 ms), audio->haptic mean 22.5 ms (p95 62.9 ms), flash commit mean 121.1 ms (p95 161.0 ms); native alignment mean 22.5 ms (p95 63.5 ms) with four spikes >= 80 ms (unitMs 40 at 82.1/82.7/84.9/103.2 ms) and nine missing `nativeTimestampMs`. `audioStartGuard=headroom` still fires with `scheduleSkewMs` spanning ~16-81 ms, so the audioStart compensation needs guardrails before these numbers stabilize.
  - `docs/logs/console-replay-20251011-181428-play-pattern.txt` keeps the audioStart run going: audio->flash mean 27.3 ms (p95 79.2 ms), audio->haptic mean 26.5 ms (p95 78.9 ms), flash commit mean 78.8 ms (p95 117.0 ms); native alignment mean 25.4 ms (p95 78.4 ms) with seven spikes >= 80 ms (unitMs 34 at 110.7/97.0/90.7/85.9/81.7 ms, unitMs 40 at 88.2 ms, unitMs 48 at 104.5 ms) and full `nativeTimestampMs`; `audioStartGuard=headroom` continued to fire with `scheduleSkewMs` hovering 70-102 ms, so batching skew persists.
  - `docs/logs/console-replay-20251011-192430-play-pattern.txt` shows the latest regression: audio->flash mean 32.8 ms (p95 95.2 ms), audio->haptic mean 31.1 ms (p95 94.3 ms), flash commit mean 91.7 ms (p95 158.0 ms); native alignment mean 30.2 ms (p95 93.5 ms) with 28 spikes >= 80 ms (unitMs 30/34/40/48/60, peak 145.0 ms) and eight missing `nativeTimestampMs`. Analyzer printed paired correlation IDs for each spike because the replay logged both legacy and mgmw* IDs; `audioStartGuard=headroom` compensation ranged 57-92 ms, confirming the audioStart batching still overshoots.
  - `docs/logs/console-replay-20251011-193145-play-pattern.txt` returns to mid-20 ms means (audio->flash 24.4 ms, p95 65.5 ms; audio->haptic 22.4 ms, p95 64.7 ms; flash commit 84.1 ms, p95 137.0 ms) but still logs 10 spikes >= 80 ms (unitMs 34 at 92.7/92.7/90.7/85.9/82.7/81.7/-- ms, unitMs 40 at 108.5/92.7/89.2 ms, unitMs 48 at 102.7 ms) plus 12 missing `nativeTimestampMs`; `audioStartGuard=headroom` compensation sits around 59-76 ms and the analyzer again shows paired correlation IDs, signaling the guard still needs refinement.
  - `docs/logs/console-replay-20251011-194352-play-pattern.txt` climbs back into upper-20 ms means (audio->flash 28.1 ms, p95 79.3 ms; audio->haptic 26.7 ms, p95 78.5 ms; flash commit 98.0 ms, p95 147.0 ms) with 18 spikes >= 80 ms (unitMs 30/34/40/48/60, peak 121.4 ms) and 11 missing `nativeTimestampMs`; `audioStartGuard=headroom` compensation sleeves 70-84 ms, so the guard remains active despite the alternating means.
  - `docs/logs/console-replay-20251011-201345-play-pattern.txt` keeps the same trend (audio->flash 27.9 ms mean / 74.7 ms p95; audio->haptic 26.4 ms mean / 74.0 ms p95; flash commit 98.3 ms mean / 151.0 ms p95) while logging 18 spikes >= 80 ms (unitMs 34/40/60, peak 102.0 ms) and eight missing `nativeTimestampMs`; `audioStartGuard=headroom` compensation hit 139 ms on the worst spike, underscoring the need to clamp or overhaul it.
  - `docs/logs/console-replay-20251011-202224-play-pattern.txt` holds similar means (audio->flash 27.9 ms, p95 91.1 ms; audio->haptic 26.2 ms, p95 90.5 ms) but flash commits balloon (mean 169.8 ms, p95 686.0 ms, max 2.95 s) while eight spikes >= 80 ms (unitMs 30/48/80, peak 119.1 ms) and 24 missing `nativeTimestampMs` surface; `audioStartGuard=headroom` compensation again ranges 80-128 ms and the analyzer prints paired correlation IDs because of the duplicate trace format.
  - `docs/logs/console-replay-20251011-203029-play-pattern.txt` pushes mean audio->flash up to 31.8 ms (p95 87.2 ms) and audio->haptic to 31.0 ms (p95 98.0 ms), keeping flash commit at 99.7 ms (p95 155.0 ms). Twenty-four spikes >= 80 ms (unitMs 30/34/40/48, peak 139.5 ms) and 10 missing `nativeTimestampMs` persist; `audioStartGuard=headroom` stays in the 75-82 ms compensation range with paired correlation IDs for each spike.
  - `docs/logs/console-replay-20251011-204825-play-pattern.txt` brings means back toward 28 ms (audio->flash 27.9 ms, p95 76.6 ms; audio->haptic 26.9 ms, p95 77.9 ms) but still shows 10 spikes >= 80 ms (unitMs 34 at 122.8/92.6/81.4 ms, unitMs 40 at 82.0/80.7 ms) and 12 missing `nativeTimestampMs`; `audioStartGuard=headroom` compensation holds between ~70-101 ms and the analyzer continues to lack `outputs.flashPulse.start` logs to compare against commits.
  - `docs/logs/console-replay-20251012-101929-play-pattern.txt` flips the picture: audio->flash 27.9 ms (p95 58.6 ms), audio->haptic 26.8 ms (p95 57.5 ms), flash commit mean 125.7 ms (p95 207.0 ms), but native alignment mean -5.5 ms (p95 38.1 ms) with no spikes and full timestamp coverage. Dispatch telemetry logged zero lead/offset for every symbol, hinting the native scheduler bypassed the audioStart guard entirely even though flash commits remain high; we should confirm whether we fell back to synchronous dispatch or hit a logging regression.
  - `docs/logs/console-replay-20251012-102506-play-pattern.txt` inches the means upward again (audio->flash 30.4 ms, p95 60.2 ms; audio->haptic 29.0 ms, p95 59.3 ms; flash commit 122.6 ms, p95 201.0 ms) and brings back two spike pairs >= 80 ms (unitMs 60, peak 130.6 ms) with the new `outputs.flashPulse` enable traces plus commit logs; `audioStartCompensationMs` tops out at 160 ms while dispatch lead/offset remain zero.
  - `docs/logs/console-replay-20251012-103407-play-pattern.txt` keeps audio->flash/haptic around 29/28 ms while flash commits stay tall (mean 122.7 ms, p95 210.0 ms); native alignment still sits around -5 ms with zero spikes, yet the guard keeps logging up to 160 ms compensation on the short pulses despite dispatch skew staying zero.
  - `docs/logs/console-replay-20251012-105330-play-pattern.txt` bumps sweep length to 405 symbols; audio->flash 29.4 ms (p95 79.4 ms), audio->haptic 28.0 ms (p95 78.4 ms), flash commit 116.2 ms (p95 198.0 ms), native alignment -4.1 ms (p95 38.6 ms), and four spikes >= 80 ms (unitMs 30/120, max 98.6 ms) despite dispatch skew holding at zero; `audioStartCompensationMs` still reaches 160 ms on the short pulses.
  - `docs/logs/console-replay-20251012-110118-play-pattern.txt` trims the sweep to 191 symbols with audio->flash 29.0 ms (p95 66.6 ms), audio->haptic 27.5 ms (p95 62.3 ms), flash commit 112.7 ms (p95 197.0 ms), and two spike pairs >= 80 ms (unitMs 80/120, max 85.1 ms). Dispatch lead/offset remain zero while `audioStartCompensationMs` continues to engage, so the guard still needs attention.
  - `docs/logs/console-replay-20251012-103407-play-pattern.txt` keeps audio->flash/haptic around 29/28 ms while flash commits stay tall (mean 122.7 ms, p95 210.0 ms); native alignment still sits around -5 ms with zero spikes, yet the guard keeps logging up to 160 ms compensation on the short pulses despite dispatch skew staying zero.
- 2025-10-11 freeform sweeps:
  - `docs/logs/send-freeform-20251011-120419-sweep.txt` and `docs/logs/send-freeform-20251011-123130-sweep.txt` held audio->flash around 2-3 ms and torch reset around 180/380 ms p95 while telemetry was coming back online.
  - `docs/logs/send-freeform-20251011-133848-sweep.txt` (with monotonic traces + analyzer update) shows audio->flash mean 4.7 ms (p95 18.8 ms), audio->haptic mean 5.5 ms (p95 15.6 ms), torch reset mean 163.7 ms (p95 369 ms), and native delay mean 23.4 ms (p95 56.9 ms). One 1.83 s flash-commit span mapped to a deliberate 1.74 s hold; no dispatch lag detected.
- Patch applied to `services/outputs/trace.ts:46` restored serialized payloads for `[outputs]` logs; future captures should continue to surface `nativeTimestampMs` as long as events include the field.

## Remaining Follow-ups
1. Replace the placeholder raw log (`docs/logs/console-replay-20251010-aligned.txt`) with an actual Play Pattern capture and summarize offsets here once archived.
2. Investigate recurring offset spikes (>= 80 ms) by reviewing the native timeline ourselves; decide whether to smooth offsets, adjust sequencing, or recalibrate clocks.
3. During freeform send-lesson sweeps, confirm offsets stay tight across WPM extremes and log any anomalies in this file.
4. Spot-check receive/practice flows post-fix (torch enabled) and archive a representative logcat bundle for comparison.

## Telemetry Checklist
- Keep `playMorse.nativeOffset.spike` traces enabled while debugging spikes; drop the threshold only if lower offsets provide signal.
- After each Play Pattern or freeform sweep, log summaries in `docs/outputs-investigation.md` so the backlog stays fresh.


  - `docs/logs/console-replay-20251011-144639-play-pattern.txt` stayed on target (audio->flash mean 24.3 ms, audio->haptic mean 22.6 ms, flash commit mean 77.5 ms, native alignment mean 21.8 ms) and produced no offsets = 80 ms.






  - docs/logs/console-replay-20251012-112831-play-pattern.txt continues the synchronous dispatch view: audio->flash 29.4 ms mean / 79.4 ms p95, audio->haptic 28.3 ms mean / 78.4 ms p95, flash commit 119.5 ms mean / 205.0 ms p95, native alignment -5.5 ms (p95 42.7 ms), and no spikes >= 80 ms; udioStartCompensationMs still engages on short pulses despite zero dispatch skew.
  - docs/logs/console-replay-20251012-114257-play-pattern.txt mirrors the synchronous dispatch view: audio->flash 30.0 ms (p95 59.3 ms), audio->haptic 28.8 ms (p95 58.6 ms), flash commit 128.8 ms (p95 208.0 ms) with native alignment -3.5 ms (p95 46.2 ms) and no spikes >= 80 ms; guard compensation is still firing on the short pulses despite zero dispatch lead.
  - docs/logs/console-replay-20251012-115159-play-pattern.txt keeps the synchronous pattern: audio->flash 30.4 ms (p95 70.0 ms), audio->haptic 29.4 ms (p95 69.5 ms), flash commit 131.3 ms (p95 215.0 ms), native alignment 0.15 ms (p95 49.7 ms), and no spikes >= 80 ms; dispatch skew stays at zero while guard compensation remains active on short pulses.
  - docs/logs/console-replay-20251012-115636-play-pattern.txt keeps the synchronous trend: audio->flash 33.4 ms (p95 77.6 ms), audio->haptic 32.4 ms (p95 76.9 ms), flash commit 134.2 ms (p95 223.0 ms), native alignment -0.4 ms (p95 51.0 ms), no spikes >= 80 ms, and guard compensation still firing despite zero dispatch skew.
  - docs/logs/console-replay-20251012-120723-play-pattern.txt marks the regression: audio->flash 83.0 ms (p95 210.2 ms), audio->haptic 81.9 ms (p95 209.7 ms), flash commit 136.5 ms (p95 264.0 ms), native alignment 80.5 ms (p95 254.6 ms), and 24 spikes >= 80 ms (unitMs 30/48/120, peak 551.4 ms) despite dispatch skew still logging zero; guard compensation is punching huge delays back in.
  - docs/logs/console-replay-20251012-123703-play-pattern.txt continues the regression: audio->flash 78.4 ms (p95 249.7 ms), audio->haptic 77.3 ms (p95 249.1 ms), flash commit 131.3 ms (p95 469.0 ms), native alignment 76.1 ms (p95 304.1 ms), and 44 spikes >= 80 ms (unitMs 30/40/60/120, peak 415.2 ms) despite dispatch skew reporting zero; the guard is still injecting large delays.
  - docs/logs/console-replay-20251012-124355-play-pattern.txt keeps the regression alive: audio->flash 64.1 ms (p95 229.8 ms), audio->haptic 62.9 ms (p95 229.2 ms), flash commit 133.0 ms (p95 404.0 ms), native alignment 61.6 ms (p95 237.1 ms), and 36 spikes >= 80 ms (unitMs 30/40/60/120, peak 295.1 ms) even though dispatch skew reports zero; the guard is still injecting the drift.
  - docs/logs/console-replay-20251012-125724-play-pattern.txt still shows the guard regression: audio->flash 78.4 ms (p95 241.1 ms), audio->haptic 75.2 ms (p95 240.5 ms), flash commit 149.4 ms (p95 537.0 ms), native alignment 64.9 ms (p95 247.1 ms), and 34 spikes >= 80 ms (peak 345.9 ms) while dispatch skew remains zero.
  - docs/logs/console-replay-20251012-132213-play-pattern.txt repeats the guard-induced regression: audio->flash 76.8 ms (p95 256.5 ms), audio->haptic 75.4 ms (p95 255.8 ms), flash commit 124.0 ms (p95 478.0 ms), native alignment 74.1 ms (p95 273.3 ms), and 46 spikes >= 80 ms (peak 380.1 ms) while dispatch skew remains zero and compensation stays active.
  - docs/logs/console-replay-20251012-132213-play-pattern.txt repeats the guard spike: audio->flash 76.8 ms (p95 256.5 ms), audio->haptic 75.4 ms (p95 255.8 ms), flash commit 124.0 ms (p95 478.0 ms), native alignment 74.1 ms (p95 273.3 ms), and 46 spikes >= 80 ms (peak 380.1 ms) while dispatch skew is still zero.
  - `docs/logs/console-replay-20251012-135609-play-pattern.txt` now lands near the expected window: audio->flash 35.9 ms (p95 81.6 ms), audio->haptic 34.6 ms (p95 80.9 ms), flash commit 100.8 ms (p95 186.0 ms), and native alignment 33.4 ms (p95 80.8 ms). Twenty-two spike pairs still cross the 80 ms threshold (peak 160.8 ms) and all map to `audioStartCompensationMs` firing on short pulses, so the guard needs another clamp pass even though dispatch skew remains at zero.
  - `docs/logs/console-replay-20251012-143924-play-pattern.txt` keeps the compensation path saturated: audio->flash mean 39.6 ms (p95 98.3 ms), audio->haptic 38.2 ms (p95 97.5 ms), flash commit 104.7 ms (p95 189.0 ms), and native alignment 37.0 ms (p95 96.4 ms). Spikes climb to 141.4 ms across unitMs 30/40/48/80/120 while every flash commit logs `schedulingMode="audio-start"` with `audioStartHeadroomMs=0`, so the guard still over-corrects even though dispatch lead/offset stay pinned at zero.
  - `docs/logs/console-replay-20251012-151140-play-pattern.txt` amplifies the regression: audio->flash mean 46.7 ms (p95 127.4 ms), audio->haptic 45.5 ms (p95 126.5 ms), flash commit 103.8 ms (p95 195.0 ms), and native alignment 44.3 ms (p95 125.2 ms). Ninety-three spikes exceed 80 ms with unitMs 30 peaking at 418.3 ms, and every flash commit still logs `schedulingMode="audio-start"` plus `audioStartHeadroomMs=0`, confirming the guard is injecting the drift despite dispatch lead/offset sticking at zero.
  - `docs/logs/console-replay-20251012-153240-play-pattern.txt` widens the gap further: audio->flash mean 59.6 ms (p95 181.6 ms), audio->haptic 58.3 ms (p95 181.0 ms), flash commit 110.9 ms (p95 215.0 ms), and native alignment 57.0 ms (p95 181.2 ms). One hundred fifteen spikes land >= 80 ms (unitMs 30/40/48/60, peak 418.3 ms) and every flash commit still reports `schedulingMode="audio-start"` with `audioStartHeadroomMs=0`, so the guard remains solely responsible while dispatch lead/offset stay pinned at zero.
  - `docs/logs/console-replay-20251012-154047-play-pattern.txt` blows the guard path wide open: audio->flash mean 72.3 ms (p95 243.8 ms), audio->haptic 71.1 ms (p95 243.3 ms), flash commit 115.0 ms (p95 389.0 ms), and native alignment 69.8 ms (p95 242.6 ms). One hundred thirty-five spikes clear 80 ms (unitMs 30 peaks at 456.0 ms) and every flash commit still flags `schedulingMode="audio-start"` plus `audioStartHeadroomMs=0`; dispatch lead/offset stay at zero, underscoring that the guard is injecting the entire regression.
  - `docs/logs/console-replay-20251012-154732-play-pattern.txt` keeps compounding the issue: audio->flash mean 74.4 ms (p95 270.7 ms), audio->haptic 73.3 ms (p95 270.1 ms), flash commit 118.4 ms (p95 446.0 ms), and native alignment 72.0 ms (p95 269.4 ms). One hundred fifty-nine spikes exceed 80 ms (unitMs 30 still peaks at 456.0 ms) and `scheduleSkewMs` tops out at 779 ms; every flash commit continues to mark `schedulingMode="audio-start"` with `audioStartHeadroomMs=0` while dispatch lead/offset remain zero, so the guard is fully responsible for the runaway drift.
  - `docs/logs/console-replay-20251012-155815-play-pattern.txt` confirms the guard clamp still isn't engaging: audio->flash mean 81.8 ms (p95 308.0 ms), audio->haptic 80.7 ms (p95 307.3 ms), flash commit 122.5 ms (p95 532.0 ms), and native alignment 80.5 ms (p95 324.8 ms). One hundred eighty-three spikes exceed 80 ms, unitMs 30 now peaks at 598.0 ms, and every flash commit keeps logging `schedulingMode="audio-start"` with `audioStartHeadroomMs=0`; dispatch lead/offset remain zero, so the new headroom requirement isn't switching us out of audio-start.
  - `docs/logs/console-replay-20251012-160437-play-pattern.txt` shows the clamp firing but still preserves the drift: audio->flash mean 79.4 ms (p95 313.2 ms), audio->haptic 78.2 ms (p95 312.6 ms), flash commit 125.8 ms (p95 533.0 ms), and native alignment 76.9 ms (p95 312.0 ms). One hundred ninety-three spikes exceed 80 ms with the 598.0 ms peak intact. Flash traces now flip to `schedulingMode="timeline"` with `audioStartGuard=headroom`, yet `audioStartCompensationMs` stays at 160 ms and the timeline offset reuses the huge compensation, so the fallback still injects 400-600 ms skew. Need to zero/decay the compensation when switching modes.
  - `docs/logs/console-replay-20251012-162055-play-pattern.txt` (30 WPM cap) still shows inflated analyzer numbers (audio->flash mean 2,578 ms, 1,158 ms peak) because timeline fallbacks continue to publish `audioStartCompensationMs=160`; on-device latency feels normal, but telemetry folds the stale compensation into `timelineOffsetMs`, so we need to purge it when leaving audio-start.
  - `docs/logs/console-replay-20251012-160902-play-pattern.txt` confirms compensation still sticks when we bail to timeline: audio->flash mean 81.1 ms (p95 313.2 ms), audio->haptic 79.9 ms (p95 310.7 ms), flash commit 125.5 ms (p95 533.0 ms), and native alignment 78.6 ms (p95 307.5 ms). One hundred ninety-six spikes clear 80 ms and unitMs 30 now peaks at 650.1 ms. Timeline fallbacks surface (`audioStartGuard=headroom`), but `audioStartCompensationMs` persists (20-160 ms), keeping the offsets inflated; we need to zero it out when aborting audio-start.
  - `docs/logs/console-replay-20251012-162055-play-pattern.txt` (30 WPM cap) still shows the compensation stuck: audio->flash mean 2,578.1 ms (p95 326.1 ms), audio->haptic 2,576.8 ms (p95 325.5 ms), flash commit 139.2 ms (p95 544.0 ms), and native alignment 86.6 ms (p95 323.9 ms). Two hundred five spikes exceed 80 ms with the 1,158.8 ms peak intact. Timeline fallbacks continue to log `audioStartCompensationMs=160`, confirming we must scrub compensation/timeline offsets the moment the guard flips.
  - `docs/logs/console-replay-20251012-161322-play-pattern.txt` proves the compensation reset is still broken: the run logs 2 min-scale `scheduleSkewMs` and drives audio->flash mean to 3,069 ms with native alignment 89.5 ms (p95 349.2 ms); 30 ms symbols now hit 1,159 ms of skew. Every timeline fallback still shows `audioStartCompensationMs=160` even though the guard flips to `schedulingMode="timeline"`, so we must purge the compensation (and timeline offset) once headroom collapses.
  - `docs/logs/console-replay-20251012-165835-play-pattern.txt` (30 WPM cap) finally shows the compensation clearing: audio->flash mean 47.9 ms (p95 135.4 ms), audio->haptic mean 46.5 ms (p95 134.8 ms), flash commit mean 102.5 ms (p95 175.0 ms), native alignment mean 46.4 ms (p95 138.4 ms). Timeline fallbacks now publish `audioStartGuard=headroom` without `audioStartCompensationMs`, confirming the reset works even though legacy spikes (up to 627.9 ms) still appear in the backfill.
  - `docs/logs/console-replay-20251012-175534-play-pattern.txt` (30 WPM cap) keeps the post-clamp behaviour steady: audio->flash mean 48.9 ms (p95 129.8 ms), audio->haptic mean 47.5 ms (p95 129.0 ms), flash commit mean 95.4 ms (p95 158.0 ms), native alignment mean 46.3 ms (p95 125.5 ms) with spikes now capped at 254.5 ms. Timeline fallbacks continue to publish `audioStartGuard=headroom` and no `audioStartCompensationMs`, and `docs/logs/play-pattern-20251012-175534-timeline.csv` records each fallback skew.








- 2025-10-12 20:42 Play Pattern replay (docs/logs/console-replay-20251012-204202-play-pattern.txt) stayed fully in audio-start after bypassing console guards; audioStartLeadMs now floors at 24 ms while the tone lead sits at 12 ms, keeping scheduleSkewMs in the low teens (no timeline CSV).

