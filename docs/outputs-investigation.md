# Outputs Diagnostics Log

## Current Status (2025-10-11)
- `forceCutOutputs` now runs on every verdict queue/complete transition, session start/stop, and interaction disable so tone/flash/haptics release immediately even if a release handler misses.
- Launch guardrails: keep the in-app WPM cap at 30 and validate audio->flash/haptic latency stays under 15 ms before widening the range.
- Flash overlay sits behind send/receive/practice UI layers while remaining visible on every surface; brightness tuning may still be needed for low-luminance devices.
- Send prompt card now auto-reveals the answer after wrong submissions, and a 200 ms verdict buffer (from `constants/appConfig.ts`) keeps judgement aligned with the banner animation.
- Torch release now falls back to a hard `forceTorchOff()` after every forced cut (with error logging) and signal/gap classifiers gained an extended tolerance window to stop premature wrong verdicts on dot-led characters.
- Verdict buffer now restarts whenever the user begins a new press, preventing premature verdicts while an answer is still being keyed.
- Added a verdict-finalizing guard so inputs that collide with the banner render no longer trigger audible click artifacts.
- Send verdict scoring now happens at banner display: we schedule the verdict but re-read the full input just before showing the banner so extra dots/dashes can no longer sneak through.
- Developer console now surfaces the live `ignorePressRef` indicator (reason + press ID) via the outputs trace stream, so testers can catch ignore-mode transitions without scanning logcat.
- Developer console replay pulses now schedule against the Nitro monotonic timeline (`monotonicTimestampMs` + native offsets), so JS dispatch no longer inflates latency metrics.
- Live keyer telemetry (`keyer.flash|haptics|tone|press|torch start/stop`) now emits `monotonicTimestampMs`, keeping device sweeps aligned with replay traces and the updated analyzer.
- Torch scheduling/telemetry now use the same monotonic baseline (`timelineOffsetMs`) as flash/haptic, keeping `touchToTorch` latency samples aligned with Nitro offsets (~50-60 ms after adjustment).
- Analyzer output now also surfaces the native `[outputs-audio] playMorse.dispatch/gap` telemetry; capturing with `OutputsAudio:D` ensures the dispatch lead and gap targets show up alongside the `[outputs]` stats.
- Manual validation now centers on Play Pattern captures plus the freeform send-lesson sweep; see **Testing Recipes** below for the streamlined workflow.
- Analyzer backs out high-offset regressions automatically: `scripts/analyze-logcat.ps1` prints a >=80 ms native-offset table for every run and can export spike summaries (see `docs/logs/spike-summary-play-pattern-20251011.csv` for the 13:37/14:14/14:41/14:46/14:59/15:02 comparison).
- Developer-console flash pulses now run with an 8 ms timeline lead (`flashPulse` in `services/outputs/defaultOutputsService.ts`), giving JS a small head start to close the audio->flash delta during replays.
- Tried aligning flash scheduling to `audioStartMs`, but the 2025-10-11 16:12 sweep regressed (drift ~40 ms, spikes to 199 ms), so we rolled the code back to timeline offsets and kept the `scheduleSkewMs` telemetry for diagnostics.
- Flash commit traces now log `scheduleSkewMs` so we can see how far the JS timer fires from the planned lead window.
- Temporarily bypassing torch during console/receive replays while we focus on flash/haptic alignment; re-enable once the baseline holds.
- Adaptive lead now starts at 48 ms (ratio 1.05 / offset 6 ms, min 10 ms) so audio-start pulses get a head start without over-driving long symbols before we consider timeline fallback.
- Latest Play Pattern captures keep the guard on the hook: the 17:55 run (`docs/logs/console-replay-20251012-175534-play-pattern.txt`, 30 WPM cap) shows the occasional timeline fallback but keeps audio->flash at 754.0 ms mean (p95 120 ms) with spikes still tied to guard flips; `docs/logs/play-pattern-20251012-175534-timeline.csv` lists the remaining fallback episodes.
- Follow-up 18:16 Play Pattern sweep (`docs/logs/console-replay-20251012-181629-play-pattern.txt`) confirms timeline fallbacks now clear `audioStartCompensationMs`, but every commit still runs in timeline mode with `audioStartGuard=headroom`; `scheduleSkewMs` averages 79 ms (p95 129 ms, max 524 ms) with 22% of pulses >=80 ms and 40 ms symbols carrying nearly half of the >=150 ms spikessee `docs/logs/play-pattern-20251012-181629-timeline.csv`.
- 18:33 Play Pattern sweep (`docs/logs/console-replay-20251012-183307-play-pattern.txt`) keeps compensation cleared yet remains timeline-only; analyzer shows audio->flash 47.6 ms mean (p95 133 ms) with `scheduleSkewMs` averaging 106 ms (p95 325 ms, max 617 ms) and headroom stuck negative (mean -46 ms, min -496 ms). 30 ms and 90 ms symbols dominate the >=150 ms skew tail; see `docs/logs/play-pattern-20251012-183307-timeline.csv`.
- 18:46 Play Pattern sweep (`docs/logs/console-replay-20251012-184610-play-pattern.txt`) stays timeline-only with `audioStartGuard=headroom`; `scheduleSkewMs` climbs to 119 ms mean (p95 331 ms, max 617 ms) while headroom averages -35 ms (p95 ~12 ms, min -496 ms). 778 commits captured; 19% exceed 150 ms skew (40 ms + 30 ms durations lead the spikes) and analyzer audio->flash mean sits at 49 ms (p95 139 ms). Timeline rows exported to `docs/logs/play-pattern-20251012-184610-timeline.csv`.
- 18:52 Play Pattern sweep (`docs/logs/console-replay-20251012-185225-play-pattern.txt`) still runs timeline-only with `audioStartGuard=headroom`; `scheduleSkewMs` rises to 121 ms mean (p95 303 ms, max 617 ms) while headroom improves slightly to -27 ms mean (p95 ~12 ms, min -496 ms). 20% of commits exceed 150 ms skew (40 ms = 28%, 120 ms = 18%, 30 ms = 16% of the spikes), audio->flash averages 47.7 ms (p95 123 ms), and CSV lives at `docs/logs/play-pattern-20251012-185225-timeline.csv`.
- 19:01 Play Pattern sweep (`docs/logs/console-replay-20251012-190102-play-pattern.txt`) adds 65 `session.receive.replay` commits to the Play Pattern run; analyzer sees audio->flash mean 43.6 ms (p95 104.5 ms) but flash-commit mean balloons to 2.24 s (p95 11.1 s) because the receive pulses sit idle in the log. The 997 Play Pattern fallbacks stay timeline-only with `audioStartGuard=headroom` (headroom mean -17 ms, p95 ~12 ms) and `scheduleSkewMs` remains 120 ms mean (p95 271 ms, max 617 ms); 21% of commits exceed 150 ms skew with 40 ms symbols now 33% of that tail, followed by 120 ms (19%) and 60 ms (15%). Receive pulses (blank guard/headroom) add another 65 rows with ~68 ms mean skew. CSV: `docs/logs/play-pattern-20251012-190102-timeline.csv`.
- 19:17 Play Pattern sweep (`docs/logs/console-replay-20251012-191728-play-pattern.txt`) runs after the receive replay appended to the prior log; analyzer sees audio->flash mean 382,992 ms (p95 2.15 s) thanks to the lingering receive pulses while Play Pattern commits themselves stay in the ~44 ms band. Timeline export mixes 794 Play Pattern rows (all `audioStartGuard=headroom`, headroom locked at 12 ms) with 346 receive rows (147 blank guard, 199 headroom). Play Pattern `scheduleSkewMs` averages 123 ms (p95 197 ms, max 396 ms) with 25% of commits >=150 ms (40 ms symbols 44% of those spikes, 120 ms 30%, 60 ms 24%). CSV: `docs/logs/play-pattern-20251012-191728-timeline.csv`.
- 19:29 Play Pattern sweep (`docs/logs/console-replay-20251012-192955-play-pattern.txt`) captured immediately after clearing logcat; analyzer returns audio->flash mean 33.5 ms (p95 87.0 ms) with flash commit mean 111.1 ms (p95 201.0 ms). All 160 fallbacks are pure Play Pattern (`audioStartGuard=headroom`, headroom fixed at 12 ms), `scheduleSkewMs` averages 121.7 ms (p95 185.7 ms, max 311.2 ms), and 41 commits (25.6%) exceed 150 ms skew (8 >=200 ms) with 40 ms symbols supplying 46% of the tail. Timeline CSV: `docs/logs/play-pattern-20251012-192955-timeline.csv`.

- 19:40 Play Pattern sweep (`docs/logs/console-replay-20251012-194045-play-pattern.txt`) also ran off a cleared logcat; analyzer lands audio->flash mean 38.2 ms (p95 100.2 ms) and flash commit mean 105.9 ms (p95 168.0 ms). We logged 160 commits overall, but only 39 fell back to timeline (`audioStartGuard=age`, headroom averaging -86.5 ms and dipping to -174.7 ms), where `scheduleSkewMs` averages 84.2 ms (p95 160.8 ms, max 164.1 ms) and 40 ms units dominate the 150 ms spikes. Timeline CSV: `docs/logs/play-pattern-20251012-194045-timeline.csv`.
- 19:51 Play Pattern sweep (`docs/logs/console-replay-20251012-195117-play-pattern.txt`) stayed clean end-to-end; analyzer reports audio->flash mean 43.9 ms (p95 111.9 ms), audio->haptic mean 42.6 ms (p95 111.2 ms), flash commit mean 111.4 ms (p95 213.0 ms), and native alignment mean 41.3 ms (p95 109.9 ms). Only 15 commits fell back (`audioStartGuard=age`) with headroom averaging -123 ms (min -163 ms); their `scheduleSkewMs` averages 100.5 ms (p95 198.7 ms, max 198.7 ms) and 40 ms symbols again lead the tail. Timeline CSV: `docs/logs/play-pattern-20251012-195117-timeline.csv`.
- 20:00 Play Pattern sweep (`docs/logs/console-replay-20251012-200042-play-pattern.txt`) follows suit: audio->flash mean 41.9 ms (p95 93.0 ms), audio->haptic mean 40.8 ms (p95 92.3 ms), flash commit mean 102.3 ms (p95 210.0 ms), native alignment mean 39.6 ms (p95 95.5 ms). Eight commits slipped to timeline (`audioStartGuard=age`) with headroom averaging -123.3 ms (min -143.1 ms); their `scheduleSkewMs` averaged 125.9 ms (max 185.1 ms) and 40 ms pulses supplied the largest spikes. Timeline CSV: `docs/logs/play-pattern-20251012-200042-timeline.csv`.
- 20:15 Play Pattern sweep (`docs/logs/console-replay-20251012-201554-play-pattern.txt`) keeps audio->flash mean 37.9 ms (p95 86.4 ms), audio->haptic mean 36.5 ms (p95 85.5 ms), flash commit mean 112.4 ms (p95 201.0 ms); native alignment mean 35.3 ms (p95 85.5 ms) with 130.5 ms offsets on the worst 60 ms pulse. Only six commits fell back (`audioStartGuard=age`), headroom averaged -120.3 ms (min -141.5 ms), and their `scheduleSkewMs` averaged 80.0 ms (max 110.7 ms). Timeline CSV: `docs/logs/play-pattern-20251012-201554-timeline.csv`.
- 20:42 Play Pattern sweep (`docs/logs/console-replay-20251012-204202-play-pattern.txt`) holds audio->flash mean 39.2 ms (p95 93.8 ms) and flash commit mean 108.4 ms (p95 199.0 ms); native alignment mean 36.9 ms (p95 92.4 ms) with 151.4 ms spikes on 40 ms symbols. No commits fell back to timeline (`audioStartGuard` never flipped), so no timeline CSV was generated.
- 21:16 Play Pattern sweep (`docs/logs/console-replay-20251012-211640-play-pattern.txt`) keeps audio->flash mean 42.4 ms (p95 103.2 ms), audio->haptic mean 41.1 ms (p95 102.4 ms), flash commit mean 110.4 ms (p95 214.0 ms); native alignment mean 39.5 ms (p95 101.0 ms) with 132.6 ms spikes on a few 40 ms pulses. No commits fell back (audioStartGuard stayed clear), so there is no timeline fallback CSV for this run.
- 20:42 Play Pattern sweep (`docs/logs/console-replay-20251012-204202-play-pattern.txt`) holds audio->flash mean 39.2 ms (p95 93.8 ms) and flash commit mean 108.4 ms (p95 199.0 ms); native alignment mean 36.9 ms (p95 92.4 ms) with 151.4 ms spikes on 40 ms symbols. No commits fell back to timeline (`audioStartGuard` never flipped), so no timeline CSV was generated.
- 21:16 Play Pattern sweep (`docs/logs/console-replay-20251012-211640-play-pattern.txt`) keeps audio->flash mean 42.4 ms (p95 103.2 ms), audio->haptic mean 41.1 ms (p95 102.4 ms), flash commit mean 110.4 ms (p95 214.0 ms); native alignment mean 39.5 ms (p95 101.0 ms) with 132.6 ms spikes on a few 40 ms pulses. No commits fell back (audioStartGuard stayed clear), so there is no timeline fallback CSV for this run.
- 21:40 Play Pattern sweep (`docs/logs/console-replay-20251012-204202-play-pattern.txt`) holds audio->flash mean 39.2 ms (p95 93.8 ms) and flash commit mean 108.4 ms (p95 199.0 ms); native alignment mean 36.9 ms (p95 92.4 ms) with 151.4 ms spikes on 40 ms symbols. No commits fell back to timeline (`audioStartGuard` never flipped), so no timeline CSV was generated.
- 20:42 Play Pattern sweep (`docs/logs/console-replay-20251012-204202-play-pattern.txt`) holds audio->flash mean 39.2 ms (p95 93.8 ms) and flash commit mean 108.4 ms (p95 199.0 ms); native alignment mean 36.9 ms (p95 92.4 ms) with 151.4 ms spikes on 40 ms symbols. No commits fell back to timeline (`audioStartGuard` never flipped), so no timeline CSV was generated.
- 21:16 Play Pattern sweep (`docs/logs/console-replay-20251012-211640-play-pattern.txt`) keeps audio->flash mean 42.4 ms (p95 103.2 ms), audio->haptic mean 41.1 ms (p95 102.4 ms), flash commit mean 110.4 ms (p95 214.0 ms); native alignment mean 39.5 ms (p95 101.0 ms) with 132.6 ms spikes on a few 40 ms pulses. No commits fell back (audioStartGuard stayed clear), so there is no timeline fallback CSV for this run.
- 21:40 Play Pattern sweep (`docs/logs/console-replay-20251012-211640-play-pattern.txt`) keeps audio->flash mean 42.4 ms (p95 103.2 ms), audio->haptic mean 41.1 ms (p95 102.4 ms), flash commit mean 110.4 ms (p95 214.0 ms); native alignment mean 39.5 ms (p95 101.0 ms) with 132.6 ms spikes on a few 40 ms pulses. No commits fell back (audioStartGuard stayed clear), so there is no timeline fallback CSV for this run.
- 21:34 Play Pattern sweep (`docs/logs/console-replay-20251012-213356-play-pattern.txt`) stays on chronically negative guard headroom but never falls back; audio->flash mean 43.5 ms (p95 102.5 ms), audio->haptic mean 42.2 ms (p95 101.5 ms), flash commit mean 104.2 ms (p95 196.0 ms), native alignment mean 41.0 ms (p95 99.6 ms) with a 160 ms spike on one 40 ms pulse. No timeline fallbacks occurred, so no CSV exists for this run.
- 21:40 Play Pattern sweep (`docs/logs/console-replay-20251012-214039-play-pattern.txt`) keeps audio->flash mean 37.4 ms (p95 89.3 ms), audio->haptic mean 35.9 ms (p95 84.0 ms), flash commit mean 109.2 ms (p95 187.0 ms); native alignment mean 34.5 ms (p95 87.2 ms) with a 160.1 ms spike on a single 40 ms symbol. No timeline fallbacks occurred (`audioStartGuard` stayed off), hence no timeline CSV.
- 21:46 Play Pattern sweep (`docs/logs/console-replay-20251012-214601-play-pattern.txt`) holds audio->flash mean 36.8 ms (p95 82.8 ms), audio->haptic mean 35.4 ms (p95 82.1 ms), flash commit mean 109.2 ms (p95 195.0 ms); native alignment mean 34.1 ms (p95 82.7 ms) with 117.4 ms spikes on a 120 ms symbol. No timeline fallbacks occurred (`audioStartGuard` never flipped), so no timeline CSV was generated.
- 21:53 Play Pattern sweep (`docs/logs/console-replay-20251012-215318-play-pattern.txt`) keeps audio->flash mean 39.9 ms (p95 101.1 ms), audio->haptic mean 38.7 ms (p95 100.5 ms), flash commit mean 108.1 ms (p95 212.0 ms); native alignment mean 37.3 ms (p95 99.8 ms) with 119.3 ms spikes on a few symbols. No timeline fallbacks occurred (`audioStartGuard` stayed off), so no timeline CSV.
- 22:01 Play Pattern sweep (`docs/logs/console-replay-20251012-220152-play-pattern.txt`) holds audio->flash mean 41.2 ms (p95 105.7 ms), audio->haptic mean 39.8 ms (p95 104.7 ms), flash commit mean 108.9 ms (p95 212.0 ms); native alignment mean 38.4 ms (p95 103.6 ms) with 123.9 ms spikes on a few symbols. No timeline fallbacks occurred (`audioStartGuard` stayed off), so no timeline CSV.
- 22:11 Play Pattern sweep (`docs/logs/console-replay-20251012-221137-play-pattern.txt`) keeps audio->flash mean 38.9 ms (p95 89.9 ms), audio->haptic mean 37.6 ms (p95 88.3 ms), flash commit mean 110.7 ms (p95 203.0 ms); native alignment mean 36.2 ms (p95 87.6 ms) with a 162.7 ms spike on a 40 ms pulse. No timeline fallbacks occurred (`audioStartGuard` stayed off), so no timeline CSV.
- 22:40 Play Pattern sweep (`docs/logs/console-replay-20251012-224008-play-pattern.txt`) keeps audio->flash mean 39.1 ms (p95 89.5 ms), audio->haptic mean 37.8 ms (p95 88.8 ms), flash commit mean 108.5 ms (p95 194.0 ms); native alignment mean 36.5 ms (p95 92.3 ms) with 133.7 ms spikes on a few symbols. No timeline fallbacks occurred (`audioStartGuard` stayed off), so no timeline CSV.
- 23:51 Play Pattern sweep (`docs/logs/console-replay-20251012-235151-play-pattern.txt`) shows analyzer means drifting upward (audio->flash mean 93.5 ms, p95 214.9 ms; flash commit mean 144.3 ms, p95 205.0 ms) and native offsets spiking into multi-second ranges (up to 9.1 s) despite every commit staying in audio-start. No timeline fallbacks were captured, so this run likely accumulated stale receive data; rerun after clearing sources to confirm.
- 23:56 Play Pattern sweep (`docs/logs/console-replay-20251012-235625-play-pattern.txt`) still surfaces huge audio->flash means (122.5 ms) and native offsets (up to 9.1 s) despite zero timeline fallbacks—another sign stale receive replay is mixed in even after clearing logcat. Aim to isolate the replay source before relying on these metrics.

